"use strict";(self.webpackChunkrke_2_docs=self.webpackChunkrke_2_docs||[]).push([[9751],{2812:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>a,metadata:()=>d,toc:()=>o});var s=t(5893),r=t(1151);const a={title:"Helm Integration"},i=void 0,d={id:"helm",title:"Helm Integration",description:"Helm is the package management tool of choice for Kubernetes. Helm charts provide templating syntax for Kubernetes YAML manifest documents. With Helm we can create configurable deployments instead of just using static files. For more information about creating your own catalog of deployments, check out the docs at https://helm.sh/docs/intro/quickstart/.",source:"@site/docs/helm.md",sourceDirName:".",slug:"/helm",permalink:"/helm",draft:!1,unlisted:!1,editUrl:"https://github.com/rancher/rke2-docs/edit/main/docs/helm.md",tags:[],version:"current",lastUpdatedAt:1708109966,formattedLastUpdatedAt:"Feb 16, 2024",frontMatter:{title:"Helm Integration"},sidebar:"mySidebar",previous:{title:"Networking",permalink:"/networking"},next:{title:"Advanced Options and Configuration",permalink:"/advanced"}},c={},o=[{value:"Automatically Deploying Manifests and Helm Charts",id:"automatically-deploying-manifests-and-helm-charts",level:3},{value:"File Naming Requirements",id:"file-naming-requirements",level:4},{value:"Disabling AddOns",id:"disabling-addons",level:3},{value:"Using the Helm CRD",id:"using-the-helm-crd",level:3},{value:"HelmChart Field Definitions",id:"helmchart-field-definitions",level:4},{value:"Customizing Packaged Components with HelmChartConfig",id:"customizing-packaged-components-with-helmchartconfig",level:3}];function l(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h3:"h3",h4:"h4",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,r.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["Helm is the package management tool of choice for Kubernetes. Helm charts provide templating syntax for Kubernetes YAML manifest documents. With Helm we can create configurable deployments instead of just using static files. For more information about creating your own catalog of deployments, check out the docs at ",(0,s.jsx)(n.a,{href:"https://helm.sh/docs/intro/quickstart/",children:"https://helm.sh/docs/intro/quickstart/"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["RKE2 does not require any special configuration to use with Helm command-line tools. Just be sure you have properly set up your kubeconfig as per the section about ",(0,s.jsx)(n.a,{href:"/cluster_access",children:"cluster access"}),". RKE2 does include some extra functionality to make deploying both traditional Kubernetes resource manifests and Helm Charts even easier with the ",(0,s.jsx)(n.a,{href:"#using-the-helm-crd",children:"rancher/helm-release CRD."})]}),"\n",(0,s.jsx)(n.h3,{id:"automatically-deploying-manifests-and-helm-charts",children:"Automatically Deploying Manifests and Helm Charts"}),"\n",(0,s.jsxs)(n.p,{children:["Any Kubernetes manifests found in ",(0,s.jsx)(n.code,{children:"/var/lib/rancher/rke2/server/manifests"})," will automatically be deployed to RKE2 in a manner similar to ",(0,s.jsx)(n.code,{children:"kubectl apply"}),". Manifests deployed in this manner are managed as AddOn custom resources, and can be viewed by running ",(0,s.jsx)(n.code,{children:"kubectl get addon -A"}),". By default, you will find AddOns for packaged components such as CoreDNS, Nginx-Ingress, and Metrics Server. AddOns are created automatically by the deploy controller, and are named based on their filename in the manifests directory."]}),"\n",(0,s.jsxs)(n.p,{children:["It is also possible to deploy Helm charts as AddOns. RKE2 includes a ",(0,s.jsx)(n.a,{href:"https://github.com/k3s-io/helm-controller/",children:"Helm Controller"})," that manages Helm charts using a HelmChart Custom Resource Definition (CRD)."]}),"\n",(0,s.jsx)(n.h4,{id:"file-naming-requirements",children:"File Naming Requirements"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"AddOn"})," name for each file in the manifest directory is derived from the file basename.\nEnsure that all files within the manifests directory (or within any subdirectories) have names that are unique, and adhere to Kubernetes ",(0,s.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/overview/working-with-objects/names/",children:"object naming restrictions"}),".\nCare should also be taken not to conflict with names in use by the default RKE2 packaged components, even if those components are disabled."]}),"\n",(0,s.jsx)(n.p,{children:"An example of an error that would be reported if the file name contains underscores:"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.code,{children:"Failed to process config: failed to process /var/lib/rancher/rke2/server/manifests/example_manifest.yaml:    Addon.k3s.cattle.io \"example_manifest\" is invalid: metadata.name: Invalid value: \"example_manifest\":     a lowercase RFC 1123 subdomain must consist of lower case alphanumeric characters, '-' or '.', and must start and end with an alphanumeric character    (e.g. 'example.com', regex used for validation is '[a-z0-9]([-a-z0-9]*[a-z0-9])?(\\\\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*')"})}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"disabling-addons",children:"Disabling AddOns"}),"\n",(0,s.jsx)(n.p,{children:"The AddOns for packaged components listed above, in addition to AddOns for any additional manifests placed in the manifests directory, can be disabled with the --disable flag. Disabled AddOns are actively uninstalled from the cluster, and the source files deleted from the manifests directory."}),"\n",(0,s.jsxs)(n.p,{children:["For example, to disable CoreDNS from being installed on a new cluster, or to uninstall it and remove the manifest from an existing cluster, you can start RKE2 with ",(0,s.jsx)(n.code,{children:"disable: rke2-coredns"})," in the config file. Multiple items can be disabled in a nested list."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# /etc/rancher/rke2/config.yaml\ndisable:\n  - rke2-coredns\n  - rke2-metrics-server\n"})}),"\n",(0,s.jsx)(n.h3,{id:"using-the-helm-crd",children:"Using the Helm CRD"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.a,{href:"https://github.com/k3s-io/helm-controller#helm-controller",children:"HelmChart resource definition"})," captures most of the options you would normally pass to the ",(0,s.jsx)(n.code,{children:"helm"})," command-line tool. Here's an example of how you might deploy Grafana from the default chart repository, overriding some of the default chart values. Note that the HelmChart resource itself is in the ",(0,s.jsx)(n.code,{children:"kube-system"})," namespace, but the chart's resources will be deployed to the ",(0,s.jsx)(n.code,{children:"monitoring"})," namespace."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'apiVersion: helm.cattle.io/v1\nkind: HelmChart\nmetadata:\n  name: grafana\n  namespace: kube-system\nspec:\n  chart: stable/grafana\n  targetNamespace: monitoring\n  set:\n    adminPassword: "NotVerySafePassword"\n  valuesContent: |-\n    image:\n      tag: master\n    env:\n      GF_EXPLORE_ENABLED: true\n    adminUser: admin\n    sidecar:\n      datasources:\n        enabled: true\n'})}),"\n",(0,s.jsx)(n.p,{children:"An example of deploying a helm chart from a private repo with authentication:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: helm.cattle.io/v1\nkind: HelmChart\nmetadata:\n  namespace: kube-system\n  name: example-app\nspec:\n  targetNamespace: example-space\n  createNamespace: true\n  version: v1.2.3\n  chart: example-app\n  repo: https://secure-repo.example.com\n  authSecret:\n    name: example-repo-auth\n  repoCAConfigMap:\n    name: example-repo-ca\n  valuesContent: |-\n    image:\n      tag: v1.2.2\n---\napiVersion: v1\nkind: Secret\nmetadata:\n  namespace: kube-system\n  name: example-repo-auth\ntype: kubernetes.io/basic-auth\nstringData:\n  username: user\n  password: pass\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  namespace: kube-system\n  name: example-repo-ca\ndata:\n  ca.crt: |-\n    -----BEGIN CERTIFICATE-----\n    <YOUR CERTIFICATE>\n    -----END CERTIFICATE-----\n"})}),"\n",(0,s.jsx)(n.h4,{id:"helmchart-field-definitions",children:"HelmChart Field Definitions"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Field"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Helm Argument / Flag Equivalent"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"metadata.name"}),(0,s.jsx)(n.td,{}),(0,s.jsx)(n.td,{children:"Helm Chart name"}),(0,s.jsx)(n.td,{children:"NAME"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.chart"}),(0,s.jsx)(n.td,{}),(0,s.jsx)(n.td,{children:"Helm Chart name in repository, or complete HTTPS URL to chart archive (.tgz)"}),(0,s.jsx)(n.td,{children:"CHART"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.targetNamespace"}),(0,s.jsx)(n.td,{children:"default"}),(0,s.jsx)(n.td,{children:"Helm Chart target namespace"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--namespace"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.createNamespace"}),(0,s.jsx)(n.td,{children:"false"}),(0,s.jsx)(n.td,{children:"Create target namespace if not present"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--create-namespace"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.version"}),(0,s.jsx)(n.td,{}),(0,s.jsx)(n.td,{children:"Helm Chart version (when installing from repository)"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--version"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.repo"}),(0,s.jsx)(n.td,{}),(0,s.jsx)(n.td,{children:"Helm Chart repository URL"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--repo"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.repoCA"}),(0,s.jsx)(n.td,{}),(0,s.jsx)(n.td,{children:"Verify certificates of HTTPS-enabled servers using this CA bundle. Should be a string containing one or more PEM-encoded CA Certificates."}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--ca-file"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.repoCAConfigMap"}),(0,s.jsx)(n.td,{}),(0,s.jsxs)(n.td,{children:["Reference to a ConfigMap containing CA Certificates to be be trusted by Helm. Can be used along with or instead of ",(0,s.jsx)(n.code,{children:"repoCA"})]}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--ca-file"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.helmVersion"}),(0,s.jsx)(n.td,{children:"v3"}),(0,s.jsxs)(n.td,{children:["Helm version to use (",(0,s.jsx)(n.code,{children:"v2"})," or ",(0,s.jsx)(n.code,{children:"v3"}),")"]}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.bootstrap"}),(0,s.jsx)(n.td,{children:"False"}),(0,s.jsx)(n.td,{children:"Set to True if this chart is needed to bootstrap the cluster (Cloud Controller Manager, etc)"}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.set"}),(0,s.jsx)(n.td,{}),(0,s.jsx)(n.td,{children:"Override simple default Chart values. These take precedence over options set via valuesContent."}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"--set"})," / ",(0,s.jsx)(n.code,{children:"--set-string"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.jobImage"}),(0,s.jsx)(n.td,{}),(0,s.jsxs)(n.td,{children:["Specify the image to use when installing the helm chart. E.g. rancher/klipper-helm",":v0",".3.0 ."]}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.backOffLimit"}),(0,s.jsx)(n.td,{children:"1000"}),(0,s.jsx)(n.td,{children:"Specify the number of retries before considering a job failed."}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.timeout"}),(0,s.jsx)(n.td,{children:"300s"}),(0,s.jsxs)(n.td,{children:["Timeout for Helm operations, as a ",(0,s.jsx)(n.a,{href:"https://pkg.go.dev/time#ParseDuration",children:"duration string"})," (",(0,s.jsx)(n.code,{children:"300s"}),", ",(0,s.jsx)(n.code,{children:"10m"}),", ",(0,s.jsx)(n.code,{children:"1h"}),", etc)"]}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--timeout"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.failurePolicy"}),(0,s.jsx)(n.td,{children:"reinstall"}),(0,s.jsxs)(n.td,{children:["Set to ",(0,s.jsx)(n.code,{children:"abort"})," which case the Helm operation is aborted, pending manual intervention by the operator."]}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.authSecret"}),(0,s.jsx)(n.td,{}),(0,s.jsxs)(n.td,{children:["Reference to Secret of type ",(0,s.jsx)(n.code,{children:"kubernetes.io/basic-auth"})," holding Basic auth credentials for the Chart repo."]}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.authPassCredentials"}),(0,s.jsx)(n.td,{children:"false"}),(0,s.jsx)(n.td,{children:"Pass Basic auth credentials to all domains."}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--pass-credentials"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.dockerRegistrySecret"}),(0,s.jsx)(n.td,{}),(0,s.jsxs)(n.td,{children:["Reference to Secret of type ",(0,s.jsx)(n.code,{children:"kubernetes.io/dockerconfigjson"})," holding Docker auth credentials for the OCI-based registry acting as the Chart repo."]}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.valuesContent"}),(0,s.jsx)(n.td,{}),(0,s.jsx)(n.td,{children:"Override complex default Chart values via YAML file content"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--values"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"spec.chartContent"}),(0,s.jsx)(n.td,{}),(0,s.jsx)(n.td,{children:"Base64-encoded chart archive .tgz - overrides spec.chart"}),(0,s.jsx)(n.td,{children:"CHART"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"customizing-packaged-components-with-helmchartconfig",children:"Customizing Packaged Components with HelmChartConfig"}),"\n",(0,s.jsxs)(n.p,{children:["To allow overriding values for packaged components that are deployed as HelmCharts (such as Canal, CoreDNS, Nginx-Ingress, etc), RKE2 supports customizing deployments via a ",(0,s.jsx)(n.code,{children:"HelmChartConfig"})," resources. The ",(0,s.jsx)(n.code,{children:"HelmChartConfig"})," resource must match the name and namespace of its corresponding HelmChart, and supports providing additional ",(0,s.jsx)(n.code,{children:"valuesContent"}),", which is passed to the ",(0,s.jsx)(n.code,{children:"helm"})," command as an additional value file."]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["HelmChart ",(0,s.jsx)(n.code,{children:"spec.set"})," values override HelmChart and HelmChartConfig ",(0,s.jsx)(n.code,{children:"spec.valuesContent"})," settings."]})}),"\n",(0,s.jsxs)(n.p,{children:["For example, to customize the packaged CoreDNS configuration, you can create a file named ",(0,s.jsx)(n.code,{children:"/var/lib/rancher/rke2/server/manifests/rke2-coredns-config.yaml"})," and populate it with the following content:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: helm.cattle.io/v1\nkind: HelmChartConfig\nmetadata:\n  name: rke2-coredns\n  namespace: kube-system\nspec:\n  valuesContent: |-\n    image: coredns/coredns\n    imageTag: v1.7.1\n"})}),"\n",(0,s.jsxs)(n.p,{children:["You can find all the packaged Helm charts including their documentation and default values in the ",(0,s.jsx)(n.a,{href:"https://github.com/rancher/rke2-charts/tree/main/charts",children:"RKE2 charts repository"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>d,a:()=>i});var s=t(7294);const r={},a=s.createContext(r);function i(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);